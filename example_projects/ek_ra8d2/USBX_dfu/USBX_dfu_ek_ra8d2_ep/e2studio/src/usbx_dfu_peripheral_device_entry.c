/***********************************************************************************************************************
 * File Name    : usbx_dfu_peripheral_device_entry.c
 * Description  : Contains macros and functions used usbx_dfu_peripheral_device functionality.
 **********************************************************************************************************************/
/***********************************************************************************************************************
* Copyright (c) 2022 - 2025 Renesas Electronics Corporation and/or its affiliates
*
* SPDX-License-Identifier: BSD-3-Clause
***********************************************************************************************************************/

#include "usbx_cdc_dfu_peri_device_common.h"
#include "usbx_dfu_peripheral_device.h"
#include "common_utils.h"
#include "ux_api.h"

/*******************************************************************************************************************//**
 * @addtogroup usbx_dfu_ep
 * @{
 **********************************************************************************************************************/

/*******************************************************************************************************************//**
 * Global variables
 **********************************************************************************************************************/
volatile _Bool g_download_done;
volatile _Bool g_dfuManifestation_done;

_Bool upload_done;

UX_SLAVE_CLASS_DFU_PARAMETER g_ux_dfu_peri_class_parameter;
UX_SLAVE_CLASS_DFU * volatile gp_peri_cdc_dfu_device;

/* DFU data Buffer */
UCHAR g_dfu_data[BUFFER_SIZE] = {RESET_VALUE};

/* Pre-defined DFU data to check data integrity */
/* Note: The user should update the buffer size based on the selected verification scheme. */
#if defined (BOARD_RA4L1_EK)
UCHAR g_pre_dfu_data[BUFFER_SIZE] = {"01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789*******1KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789*******2KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789*******3KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     };
#else
UCHAR g_pre_dfu_data[BUFFER_SIZE] = {"01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789*******1KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789*******2KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789*******3KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789*******4KB*0123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "456789012345678901234567890123456789*********512*0123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "123456789012345678901234567890123456789012345678901234567890123456789*******5KB*"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789*******6KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789*******7KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789*******8KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789*******9KB*0123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "456789012345678901234567890123456789*********512*0123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "123456789012345678901234567890123456789012345678901234567890123456789******10KB*"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789******11KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789******12KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789******13KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789******14KB*0123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "456789012345678901234567890123456789*********512*0123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "123456789012345678901234567890123456789012345678901234567890123456789******15KB*"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789******16KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789******17KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789******18KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789******19KB*0123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "456789012345678901234567890123456789*********512*0123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "123456789012345678901234567890123456789012345678901234567890123456789******20KB*"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789******21KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789******22KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789******23KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789******24KB*0123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "45678901234567890123456789012345678901234567890123456789012345678901234567890123"
                                     "456789012345678901234567890123456789*********512*0123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                                     "123456789012345678901234567890123456789012345678901234567890123456789******25KB*"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789012345678901234567890123456789012345678901234567890123456789"
                                     "01234567890123456789*********512*01234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789012345678901234567890123456"
                                     "78901234567890123456789012345678901234567890123456789******26KB*0123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "67890123456789012345678901234567890123456789012345678901234567890123456789012345"
                                     "6789*********512*012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "34567890123456789012345678901234567890123456789012345678901234567890123456789012"
                                     "3456789012345678901234567890123456789******27KB*01234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789012345678901"
                                     "23456789012345678901234567890123456789012345678901234567890123456789*********512"
                                     "*0123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "90123456789012345678901234567890123456789012345678901234567890123456789012345678"
                                     "901234567890123456789******28KB*012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "89012345678901234567890123456789012345678901234567890123456789012345678901234567"
                                     "8901234567890123456789012345678901234567890123456789*********512*012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789012345678901234567890123456789012345678901234567890123456789012345678901234"
                                     "56789******29KB*"};
#endif

ULONG g_data_cnt = RESET_VALUE;
ULONG g_block_no_cnt = RESET_VALUE;

/*******************************************************************************************************************//**
 * Global Function prototypes
 **********************************************************************************************************************/
void current_drivers_un_init(void);
void dfu_device_init(void);

/*******************************************************************************************************************//**
 * CDC Class Private Function prototypes
 **********************************************************************************************************************/
static void usbx_dfu_instance_activate(VOID * peri_dfu_device_instance);
static void usbx_dfu_instance_deactivate(VOID * peri_dfu_device_instance);
static UINT usbx_dfu_write_callback(VOID *dfu, ULONG block_number, UCHAR * data_pointer, ULONG length,\
                                    ULONG *media_status);
static UINT ux_slave_class_dfu_notify(VOID *dfu, ULONG notification);
static UINT ux_slave_class_dfu_get_status(void *dfu, ULONG *media_status);
static UINT usbx_dfu_device_status_change_callback(ULONG status);

/*******************************************************************************************************************//**
 * @brief     In this function, it activates the DFU instance.
 * @param[in] peri_dfu_device_instance    Pointer to the area store the instance pointer.
 * @retval    None.
 **********************************************************************************************************************/
static void usbx_dfu_instance_activate(VOID * peri_dfu_device_instance)
{
    /* Save the peripheral DFU device instance. */
    gp_peri_cdc_dfu_device = (UX_SLAVE_CLASS_DFU *) peri_dfu_device_instance;
    tx_semaphore_put(&g_peri_cdc_dfu_device_connect_semaphore0);
    PRINT_INFO_STR("RA USBX peripheral DFU Device ACTIVATED");
    tx_thread_sleep(THREAD_SLEEP_10);
}

/*******************************************************************************************************************//**
 * @brief     In this function, it deactivates the DFU instance.
 * @param[in] peri_dfu_device_instance    Pointer to the area store the instance pointer.
 * @retval    None.
 **********************************************************************************************************************/
static void usbx_dfu_instance_deactivate(VOID * peri_dfu_device_instance)
{
    FSP_PARAMETER_NOT_USED(peri_dfu_device_instance);
    /* Deactivate the peripheral DFU device instance */
    gp_peri_cdc_dfu_device = NULL;
    tx_semaphore_put(&g_peri_cdc_dfu_device_connect_semaphore0);
    PRINT_INFO_STR("RA USBX peripheral DFU Device DEACTIVATED");
    tx_thread_sleep(THREAD_SLEEP_10);
}

/*******************************************************************************************************************//**
 * @brief     Callback function for USBX Peripheral DFU device status changes.
 * @param[in] status     USB status code indicating the DFU device state or event.
 * @retval    UX_SUCCESS Returned to indicate the status change was handled successfully.
 **********************************************************************************************************************/
UINT usbx_dfu_device_status_change_callback(ULONG status)
{

    if (UX_DEVICE_ATTACHED == status)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device ATTACHED");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_DEVICE_ADDRESSED == status)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device ADDRESSED");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_DEVICE_CONFIGURED == status)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device CONFIGURED");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_DEVICE_SUSPENDED == status)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device SUSPENDED");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_DEVICE_RESUMED == status)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device RESUMED");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_DEVICE_FORCE_DISCONNECT == status)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Force Disconnect");
        tx_thread_sleep(THREAD_SLEEP_10);
        if (_ux_system_slave -> ux_system_slave_device_dfu_state_machine == UX_SYSTEM_DFU_STATE_DFU_MANIFEST_WAIT_RESET)
        {
            g_dfuManifestation_done = true;
        }
    }
    return UX_SUCCESS;
}

/*******************************************************************************************************************//**
 * @brief     This function initializes the RA USBX peripheral DFU device.
 * @param[in] None.
 * @retval    None.
 **********************************************************************************************************************/
void dfu_device_init(void)
{
    UINT status = RESET_VALUE;
#if (WORK_AROUND == ONE)
    {
        _ux_system_slave -> ux_system_slave_device.ux_slave_device_configuration_selected = ZERO;
    }
#endif

    tx_thread_sleep(THREAD_SLEEP_50);
    status = ux_device_stack_initialize(NULL,
                                        UX_ZERO,
                                        g_dfu_device_framework_full_speed,
                                        DFU_DEVICE_FRAME_LENGTH_FULL_SPEED,
                                        g_dfu_string_framework,
                                        DFU_STRING_FRAMEWORK_LENGTH,
                                        g_language_id_framework,
                                        DFU_LANGUAGE_ID_FRAME_WORK_LENGTH,
                                        &usbx_dfu_device_status_change_callback);
    /* Handle error */
    if (UX_SUCCESS != status)
    {
        PRINT_ERR_STR("ux_device_stack_initialize API failed");
        ERROR_TRAP(status);
    }
    PRINT_INFO_STR("ux_device_stack_initialize successfully");

    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_instance_activate = usbx_dfu_instance_activate;
    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_instance_deactivate = usbx_dfu_instance_deactivate;

    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_framework = g_dfu_device_framework_full_speed;
    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_framework_length = DFU_DEVICE_FRAME_LENGTH_FULL_SPEED;

    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_write = usbx_dfu_write_callback;

    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_get_status = ux_slave_class_dfu_get_status;
    g_ux_dfu_peri_class_parameter.ux_slave_class_dfu_parameter_notify = ux_slave_class_dfu_notify;


    /* ux_device stack class registration */
    status = ux_device_stack_class_register(_ux_system_slave_class_dfu_name, ux_device_class_dfu_entry, CONFIG_NUMB,
                                            INTERFACE_NUMB0, (void*) &g_ux_dfu_peri_class_parameter);

    /* Handle error */
    if (UX_SUCCESS != status)
    {
        PRINT_ERR_STR("ux_device_stack_class_register API failed for DFU");
        ERROR_TRAP(status);
    }
    PRINT_INFO_STR("ux_device_stack_class_register successfully for DFU");

    status = R_USB_Open(&g_basic0_ctrl, &g_basic0_cfg);
    if (UX_SUCCESS != status)
    {
        PRINT_ERR_STR("R_USB_Open API failed");
        ERROR_TRAP(status);
    }
    PRINT_INFO_STR("R_USB_Open successfully");
}

/* RA USBX PERI DFU entry function */
void usbx_dfu_peripheral_device_entry(void)
{
    UINT  status = TX_SUCCESS;
    ULONG actual_flags = RESET_VALUE;
    while (true)
    {
        /* Check for DFU_DETACH Event */
        status = tx_event_flags_get(&ra_dfu_detach_event, DETACH_EVENT_FLAG, TX_OR_CLEAR, &actual_flags,
                                    TX_WAIT_FOREVER);
        if (TX_SUCCESS == status && DETACH_EVENT_FLAG == actual_flags)
        {
            /* Un-load all driver were loaded */
            current_drivers_un_init();
            /* Initialize DFU Device */
            dfu_device_init();

        }
        else
        {
            tx_thread_sleep(THREAD_SLEEP_10);
        }
    }
}

/*******************************************************************************************************************//**
 * @brief     This function un-initializes the RA USBX peripheral DFU device.
 * @param[in] None.
 * @retval    None.
 **********************************************************************************************************************/
void usbx_peri_dfu_un_init(void)
{
    UINT status = RESET_VALUE;

    /* USB (DFU) module stops when USB_IP0 is specified */
    status = R_USB_Close(&g_basic0_ctrl);
    if (UX_SUCCESS != status)
    {
        PRINT_ERR_STR("R_USB_Close API failed");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else
    {
        PRINT_INFO_STR("R_USB_Close successfully");
    }

    /* Unregister DFU device */
    status= ux_device_stack_class_unregister(_ux_system_slave_class_dfu_name, ux_device_class_dfu_entry);
    if (UX_SUCCESS != status)
    {
        PRINT_ERR_STR("ux_device_stack_class_unregister API failed for DFU");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else
    {
        PRINT_INFO_STR("ux_device_stack_class_unregister successfully for DFU");
    }

    status =_ux_device_stack_uninitialize();
    if (UX_SUCCESS != status)
    {
        PRINT_ERR_STR("_ux_device_stack_uninitialize API failed for CDC ACM");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else
    {
        PRINT_INFO_STR("_ux_device_stack_uninitialize successfully for CDC ACM");
    }
}

/*******************************************************************************************************************//**
 * @brief       In this function, RA USBX DFU write data to MCU.
 * @param[in]   dfu            Pointer to the DFU class instance (not used).
 * @param[in]   block_number   Block number being written by the host.
 * @param[in]   data_pointer   Pointer to the data buffer containing received bytes.
 * @param[in]   length         Number of bytes to write.
 * @param[out]  media_status   Pointer to a variable to store the media status result.
 * @retval      UX_SUCCESS     Always returns success to indicate the write operation was handled.
 **********************************************************************************************************************/
static UINT usbx_dfu_write_callback(VOID *dfu, ULONG block_number, UCHAR * data_pointer,\
                                    ULONG length, ULONG *media_status)
{
    FSP_PARAMETER_NOT_USED(dfu);
    char buffer[BUFFER_SIZE_50]={RESET_VALUE};

    for (ULONG i = 0; i < length; i++)
    {
        g_dfu_data[g_data_cnt++] = *(data_pointer + i);
    }
    if (g_block_no_cnt != block_number)
    {
        PRINT_ERR_STR("Block Number err");
    }
    g_block_no_cnt++;
    sprintf(buffer, "Bytes written: %ld", g_data_cnt);
    PRINT_INFO_STR(buffer);
    *media_status = UX_SLAVE_CLASS_DFU_MEDIA_STATUS_OK;
    return UX_SUCCESS;
}

/*******************************************************************************************************************//**
 * @brief     This function  initiates DFU application notification signals.
 * @param[in] dfu           Pointer to the DFU class instance (not used).
 * @param[in] notification  Notification code indicating the DFU operation phase.
 * @retval    UX_SUCCESS    Always returns success to indicate the notification was processed.
 **********************************************************************************************************************/
static UINT ux_slave_class_dfu_notify(VOID *dfu, ULONG notification)
{
    /* Define DFU application notification signals */
    FSP_PARAMETER_NOT_USED(dfu);

    if (UX_SLAVE_CLASS_DFU_NOTIFICATION_BEGIN_DOWNLOAD == notification)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device BEGIN DOWNLOAD");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_SLAVE_CLASS_DFU_NOTIFICATION_END_DOWNLOAD == notification)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device END DOWNLOAD");
        tx_thread_sleep(THREAD_SLEEP_10);
        g_download_done = true;
    }
    else if (UX_SLAVE_CLASS_DFU_NOTIFICATION_ABORT_DOWNLOAD == notification)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device ABORT DOWNLOAD");
        tx_thread_sleep(THREAD_SLEEP_10);

    }
    else if (UX_SLAVE_CLASS_DFU_NOTIFICATION_BEGIN_UPLOAD == notification)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device BEGIN UPLOAD");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    else if (UX_SLAVE_CLASS_DFU_NOTIFICATION_END_UPLOAD == notification)
    {
        g_block_no_cnt = ZERO;
        PRINT_INFO_STR("RA USBX Peripheral DFU Device END UPLOAD");
        upload_done = true;
        tx_thread_sleep(THREAD_SLEEP_10);

    }
    else if (UX_SLAVE_CLASS_DFU_NOTIFICATION_ABORT_UPLOAD == notification)
    {
        PRINT_INFO_STR("RA USBX Peripheral DFU Device ABORT UPLOAD");
        tx_thread_sleep(THREAD_SLEEP_10);
    }
    return UX_SUCCESS;
}

/*******************************************************************************************************************//**
 * @brief       This function initiates DFU application notification signals of media status.
 * @param[in]   dfu             Pointer to the DFU class instance (not used).
 * @param[out]  media_status    Pointer to a variable to receive the media status.
 * @retval      UX_SUCCESS      Always returns success to indicate the status was retrieved.
 **********************************************************************************************************************/
static UINT ux_slave_class_dfu_get_status(void *dfu, ULONG *media_status)
{
    /* Check if the device is still buys performing the write. Write could be delayed. */
    FSP_PARAMETER_NOT_USED(dfu);
    *media_status = UX_SLAVE_CLASS_DFU_MEDIA_STATUS_OK;
    return UX_SUCCESS;
}

/*******************************************************************************************************************//**
 * @} (end addtogroup usbx_dfu_ep)
 **********************************************************************************************************************/
